---
title: "p8105_mtp_yc4018"
author: "Yuxuan Chen"
date: "10/28/2021"
output: github_document
---
## Introduction 
and four sections corresponding to the problems below

## Problem 1 – Data.

```{r message = FALSE}
library(tidyverse)
library(patchwork)

#set the theme of all graphs
theme_set(theme_minimal() + theme(legend.position = "right"))

#set color of all graphs
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

1. load, clean, and tidy the mtp_df data
```{r}
mtp_df = readxl::read_excel("./data/p8105_mtp_data.xlsx", range = "A9:I1230") %>%  #read the table without header information
  janitor::clean_names() %>% 
  mutate(
    sex = recode(sex, `1` = "male", `0` = "female"),
    eop_size_mm = if_else(is.na(eop_size_mm), 0, eop_size_mm), # replace NA with 0 in `eop_size_mm` variable. 
    age = as.integer(age),
    age_group = case_when(
      age_group %in% c("6","7","8") ~ "6+",
      TRUE   ~ age_group)) %>% 
  rename(eop_size_group = eop_size, 
         fhp_group = fhp_category) %>% 
  mutate(
      age_group = fct_relevel(age_group, "1", "2", "3", "4", "5", "6+"),
      eop_size_group = fct_relevel(eop_size_group, "0", "1", "2", "3", "4", "5"),
      eop_visibility_classification = factor(eop_visibility_classification, levels = c("0", "1", "2")),
      fhp_group = fct_relevel(fhp_group,"0", "1", "2", "3", "4", "5","6", "7")
  )
knitr::kable(mtp_df[0:10,])
```

 - Above is the first 10 rows of the resulting dataset. 
 - Data cleaning process: after loading the dataset, I cleaned up the variable names and converted them to lower snake cases. Then based on header information, in `sex` variable, I changed the observations of `1` and `0` to be `male` and `female` respectively, and also replaced NA with 0 in `eop_size_mm` variable. Next, I changed the observations in `age` variable to be the class of integer. Since based on the article, the ages were divided into age groups of 18–30, 31–40, 41–50, 51–60, and >61, so I combined the ages older than 60 as the group of `6+`. Moreover, for naming consistency, I renamed the `eop_size` variable to be `eop_size_group`, `fhp_category` variable to be `fhp_group`. Lastly, I ordered the factors for `age_group`,`eop_size_group`,`eop_visibility_classification`, and `fhp_group` categorical variables. \newline.
  - The resulting mtp_df dataset contains 1221 observations of 9 variables. The size of this dataset is  (`r dim(mtp_df)`). I think the key variables are `age_group`, `eop_size_group`, `eop_visibility_classification`, and `fhp_group`, because `age_group` variable categorized different ages into 5 groups of 18–30, 31–40, 41–50, 51–60, and >61, `eop_size_group` variable separated EOP sizes into 6 different groups, `eop_visibility_classification` represented the sizes of EOP smaller than 5mm or larger than 5mm, and `fhp_group` categorized different FHP sizes into group based on range of 10mm.
  
```{r message = FALSE}
n_ptcp = mtp_df %>% count()

age_sex_df = 
  mtp_df %>% 
  group_by(age_group, sex) %>%
  mutate(
    age_group = recode(
      age_group, "1" = "<18", "2" = "18–30", "3" = "31–40", "4" = "41–50", "5" = "51–60", "6+" = ">60")) %>% 
  summarize(n_obs = n())

age_sex_df %>% 
  pivot_wider(
    names_from = sex,
    values_from = n_obs) %>% 
  knitr::kable(caption = "Age and Gender Distribution")

age_sex_df %>% 
  ggplot(aes(x = age_group, y = n_obs, group = sex, color = sex)) + 
  geom_point(alpha = .5) +
  geom_line(alpha = .5) +
  labs(
    title = "Scatter Plot of Age Distribution Based on Sex",
    x = "Age group",
    y = "Number of Observations"
  )

```

  - There are `r n_ptcp` participants included. Based on the table and the scatter plot, we can see that male and female have the similar distributions of number of observations in each age group. 

2. Issues in the data: 
```{r}
y = as.integer(c(18, 31, 41, 51, 61))
class(mtp_df$age)
# age:
mtp_df %>% 
  ggplot(aes(x = age_group, y = age, color = age_group)) +
  geom_point(alpha = .5) +
  geom_hline(yintercept = c(18, 31, 41, 51, 61), linetype = 3) +
  labs(
    title = "Scatter Plot of Age Data",
    x = "Age Group (years)",
    y = "Age") +
  scale_x_discrete(
    labels = c("<18", "18–30", "31–40", "41–50", "51–60", ">60")) +
  scale_color_hue(
    labels = c("<18", "18–30", "31–40", "41–50", "51–60", ">60")) +
  annotate("text", x = 0.7, y = 18, label = "y=18", vjust = -1, size = 3) +
  annotate("text", x = 0.7, y = 30, label = "y=31", vjust = -1, size = 3) +
  annotate("text", x = 0.7, y = 41, label = "y=41", vjust = -1, size = 3) +
  annotate("text", x = 0.7, y = 51, label = "y=51", vjust = -1, size = 3) +
  annotate("text", x = 0.7, y = 61, label = "y=61", vjust = -1, size = 3)

mtp_df %>% 
  filter(age_group == 1) %>% 
  select(age, age_group) %>% 
  knitr::kable()
```
 - Based on the header information, we know that the ages are divided into 5 age groups of 18–30, 31–40, 41–50, 51–60, and >61. However, based on the above scatter plot of age data, we can see that there are 2 points were contained in the group with age smaller than 18, and there is one point with age equals to 45 was mistakenly placed in this age group. 

```{r}
#EOP sizes group
mtp_df %>% 
  ggplot(aes(x = eop_size_group, y = eop_size_mm, color = eop_size_group)) +
  geom_point(alpha = .5) +
  geom_hline(yintercept = c(5, 10, 15, 20, 25), linetype = 3) +
  labs(
    title = "Scatter Plot of EOP Sizes in EOP Sizes Groups",
    x = "EOP Size Group",
    y = "EOP Size (mm)") +
  scale_color_hue(
    name = "EOP size group",
    labels = c("0 = 0-5mm", "1 = 5-10mm", "2 = 10-15mm", "3 = 15-20mm", "4 = 20-25mm", "5 = 25+mm"))

mtp_df %>% 
  filter(!eop_size_group %in% c("0","1","2","3","4","5")) %>% 
  select(eop_size_group, eop_size_mm) %>% 
  knitr::kable()
```
 
 - There is one point with EOP size equals to 15 mm was mistakenly placed in the 14.6 size group. Also, there are a lot misclassified data in the size group of 5-10, 15-20, 20-25, 25+mm.

```{r}
#eop_visibility_classification
mtp_df %>% 
  ggplot(aes(x = eop_visibility_classification, y = eop_size_mm, color = eop_visibility_classification)) +
  geom_point(alpha = .5) +
  geom_hline(yintercept = c(5), linetype = 3) +
  labs(
    title = "Scatter Plot of EOP Sizes in EOP Visibility Classification Groups",
    x = "EOP Visibility Classification Group",
    y = "EOP Size (mm)") +
  scale_color_hue(
    name = "EOP size group",
    labels = c("0 = 0mm", "1 = 0-5mm", "2 => 5mm"))
```
 - There are a lot misclassified data in all size groups.

```{r}
mtp_df %>% 
  drop_na(fhp_size_mm) %>% 
  ggplot(aes(x = fhp_group, y = fhp_size_mm, color = fhp_group)) +
  geom_point(alpha = .5) +
  geom_hline(yintercept = c(10, 20, 30, 40, 50, 60, 70, 80), linetype = 3) +
  labs(
    title = "Scatter Plot of FHP Sizes",
    x = "FHP Size Group",
    y = "FHP Size (mm)") +
  scale_color_hue(
    name = "FHP size group",
    labels = c("0 = 0-10mm", "1 = 10-20mm", "2 = 20-30mm","3 = 30-40mm", "4 = 40-50mm", "5 = 50-60mm", "6 = 60-70mm", "7 = 70-80mm"))

mtp_df %>% 
  filter(!fhp_group %in% c("0","1","2","3","4","5", "6","7")) %>% 
  select(fhp_group,fhp_size_mm) %>% 
  knitr::kable()
```
 - There is one point with 30.3mm FHP size was mistakenly placed in a 30.8 size group. Also, there are a lot misclassified data in size group 1, 2, and 4.

## Problem 2 – Visualization.

```{r message = FALSE}
FHP_plot = 
  mtp_df %>% 
  filter(age_group != 1) %>% 
  drop_na(fhp_size_mm) %>% 
  ggplot(aes(x = age_group, y = fhp_size_mm, fill = sex)) +
  geom_boxplot(alpha = .5) +
  labs(
    title = "FHP Values Across the Age Groups and Sexes",
    x = "Age Group (years)",
    y = "FHP Size (mm)") +
  scale_x_discrete(labels = c("18-30 years", "30s", "40s", "50s", ">60")) + 
  stat_summary(fun = mean, geom = "point", size = 1, position = position_dodge(width = 0.75)) +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.3, position = position_dodge(width = 0.75))

eeop_plot = 
  mtp_df %>% 
  mutate(
    eeop = case_when(
      eop_size_group %in% c("0", "1") ~ "no",
      eop_size_group %in% c("2", "3", "4", "5") ~ "yes",
      TRUE   ~ "")) %>% 
  group_by(age_group, sex, eeop) %>% 
  summarize(n_obs = n()) %>% 
  mutate(rate = prop.table(n_obs)) %>% 
  filter(eeop == "yes") %>% 
  ggplot(aes(x = age_group, y = rate)) + 
  geom_point() +  
  geom_line(aes(group = sex, color = sex))  +
  labs(
    title = "Distribution of the Rate of EEOP In Each Age Group",
    x = "Age Group (years)",
    y = "EEOP prop") +
  scale_x_discrete(labels = c("18-30 years", "30s", "40s", "50s", ">60"))
FHP_plot / eeop_plot
```

1) Improved fig.3 shows the distribution of the underlying FHP data across the age groups and sexes. In the 60+ age group, both male and female have the highest FHP size. Comparing with female, male has the higher FHP sizes within all age groups since the median of FHP size is higher for male. The mean and sd are close and near to the median in each age and sex group. \newline.  
   Bottom plot shows the distribution of the rate of enlarged EOP in each age and sex group. The trends of the distribution in the improved fig.4 are similar to the original version. Male has higher EEOP rate than female. The 18-30 year group has the highest EEOP rate. With age increases, EEOP rate decreases and EEOP becomes unlikely to occur. Then, EEOP rate slightly increases after the age of 50s.
 
```{r}
mtp_df %>%
  filter(age_group != 1) %>% 
  drop_na(fhp_size_mm) %>% 
  ggplot(aes(x = fhp_size_mm, y = eop_size_mm, color = sex)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "lm", color = "black", size = 0.5, se = FALSE) +
  facet_grid(
    sex ~ age_group,
    labeller = labeller(age_group = c("2" = "18-30 years", "3" = "30s", "4" = "40s", "5" = "50s", "6+" = ">60s"))) +
  labs(
    title = "Distribution between FHP Size and EOP Size",
    caption = "Association between FHP size and EOP size in each age and sex group",
    x = "FHP Size (mm)",
    y = "EOP Size (mm)")
```

2) In both sex groups, EOP size and FHP size have positive relationship in every age group. 





